<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mt-4">
        <h1 class="mb-0">File Analysis Results</h1>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox"/>
                <div class="slider round"></div>
            </label>
            <em>Dark Mode</em>
        </div>
    </div>

    <!-- Recommendations -->
    {% if recommendations %}
    <div class="mt-4">
        <h2>Smart Recommendations</h2>
        {% for rec in recommendations %}
            <div class="alert alert-info">{{ rec.text }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Charts -->
    <div class="row">
        <div class="col-md-6"><canvas id="fileTypeChart"></canvas></div>
        <div class="col-md-6"><canvas id="folderSizeChart"></canvas></div>
    </div>

    <!-- Duplicate Files -->
    {% if duplicates %}
    <h2 class="mt-5">Duplicate Files</h2>
    <p>Found {{ duplicates|length }} groups of duplicate files.</p>

    <form action="/optimize" method="post">
        <input type="hidden" name="optimization_type" value="delete_duplicates">

        <div class="accordion" id="duplicatesAccordion">

            {% for hash, paths in duplicates.items() %}
            {% set outer_index = loop.index0 %}

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" data-bs-toggle="collapse"
                            data-bs-target="#dup-group-{{ outer_index }}">
                        {{ paths|length }} duplicates of <strong>{{ paths[0].split('/')[-1] }}</strong>
                    </button>
                </h2>

                <div id="dup-group-{{ outer_index }}" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <p><strong>Original:</strong> {{ paths[0] }}</p>

                        <p><strong>Select duplicates to delete:</strong></p>
                        <ul class="list-unstyled">
                            {% for path in paths[1:] %}
                            <li>
                                <input type="checkbox"
                                       name="selected_files"
                                       value="{{ path }}"
                                       id="dup-{{ outer_index }}-{{ loop.index0 }}">
                                <label for="dup-{{ outer_index }}-{{ loop.index0 }}">{{ path }}</label>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

            </div>

            {% endfor %}
        </div>

        <button class="btn btn-danger mt-3">Delete Selected Duplicates</button>
    </form>
    {% endif %}

    <!-- Junk Files & Empty Folders -->
    {% if junk_files or empty_folders %}
    <h2 class="mt-5">Folder Cleanup</h2>

    <form action="/cleanup" method="post">

        {% if junk_files %}
        <h3>Junk Files ({{ junk_files|length }})
            <input type="checkbox" id="select-all-junk-files"> Select All
        </h3>
        <ul class="list-group mb-3">
            {% for file in junk_files %}
            <li class="list-group-item">
                <input type="checkbox" class="junk-file-checkbox" name="selected_files" value="{{ file }}">
                {{ file }}
            </li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if empty_folders %}
        <h3>Empty Folders ({{ empty_folders|length }})
            <input type="checkbox" id="select-all-empty-folders"> Select All
        </h3>
        <ul class="list-group mb-3">
            {% for folder in empty_folders %}
            <li class="list-group-item">
                <input type="checkbox" class="empty-folder-checkbox" name="selected_folders" value="{{ folder }}">
                {{ folder }}
            </li>
            {% endfor %}
        </ul>
        {% endif %}

        <button class="btn btn-danger mt-3">Delete Selected Items</button>
    </form>
    {% endif %}

    <!-- Time-based Archiving -->
    <h2 class="mt-5">Time-Based Archiving</h2>

    <form action="{{ url_for('dashboard') }}" method="get">
        <div class="row g-3 align-items-center">

            <div class="col-auto">Show files older than:</div>

            <div class="col-md-3">
                <select name="archive_threshold_days" class="form-select">
                    <option value="0">--- Select ---</option>
                    <option value="30" {{ 'selected' if archive_threshold_days==30 }}>30 days</option>
                    <option value="90" {{ 'selected' if archive_threshold_days==90 }}>90 days</option>
                    <option value="180" {{ 'selected' if archive_threshold_days==180 }}>180 days</option>
                    <option value="365" {{ 'selected' if archive_threshold_days==365 }}>365 days</option>
                </select>
            </div>

            <div class="col-auto"><button class="btn btn-primary">Find Files</button></div>
        </div>
    </form>

    {% if dormant_files %}
    <h3 class="mt-4">Dormant Files ({{ dormant_files|length }})</h3>

    <form action="/archive" method="post">

        <input type="hidden" name="archive_threshold_days" value="{{ archive_threshold_days }}">

        <table class="table table-striped mt-4">
            <thead>
            <tr>
                <th><input type="checkbox" id="select-all-dormant-files"> Select All</th>
                <th>Name</th>
                <th>Path</th>
                <th>Last Modified</th>
            </tr>
            </thead>

            <tbody>
            {% for file in dormant_files %}
            <tr>
                <td><input type="checkbox" class="dormant-file-checkbox" name="selected_files" checked value="{{ file.path }}"></td>
                <td>{{ file.name }}</td>
                <td>{{ file.path }}</td>
                <td>{{ file.last_modified.strftime('%Y-%m-%d') }}</td>
            </tr>
            {% endfor %}
            </tbody>

        </table>

        <button class="btn btn-warning mt-3">Archive Selected Files</button>
    </form>
    {% endif %}

    <!-- Top Files -->
    <div class="row mt-5">
        <div class="col-md-6">
            <h2>Top 5 Largest Files</h2>
            <ul class="list-group">
                {% for file in largest_files %}
                <li class="list-group-item d-flex justify-content-between">
                    {{ file.name }}
                    <span class="badge bg-primary">{{ (file.size/1024/1024)|round(2) }} MB</span>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="col-md-6">
            <h2>Top 5 Recently Modified</h2>
            <ul class="list-group">
                {% for file in recently_modified_files %}
                <li class="list-group-item d-flex justify-content-between">
                    {{ file.name }}
                    <span class="badge bg-info">{{ file.last_modified.strftime('%Y-%m-%d %H:%M') }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- All Files Table -->
    <h2 class="mt-5">All Files</h2>

    <div class="d-flex justify-content-between mb-3">
        <p>List of all analyzed files</p>
        <a href="{{ url_for('generate_csv_report') }}" class="btn btn-secondary btn-sm">Download CSV</a>
    </div>

    <form action="{{ url_for('dashboard') }}" method="get">
        <div class="row g-3">

            <div class="col-md-4">
                <input type="text" name="filter_text" class="form-control" value="{{ filter_text }}"
                       placeholder="Filter by name or path">
            </div>

            <div class="col-md-3">
                <select name="sort_by" class="form-select">
                    <option value="name" {{ 'selected' if sort_by=='name' }}>Name</option>
                    <option value="size" {{ 'selected' if sort_by=='size' }}>Size</option>
                    <option value="last_modified" {{ 'selected' if sort_by=='last_modified' }}>Last Modified</option>
                </select>
            </div>

            <div class="col-md-3">
                <select name="sort_order" class="form-select">
                    <option value="asc" {{ 'selected' if sort_order=='asc' }}>Ascending</option>
                    <option value="desc" {{ 'selected' if sort_order=='desc' }}>Descending</option>
                </select>
            </div>

            <div class="col-md-2"><button class="btn btn-primary">Apply</button></div>
        </div>
    </form>

    <form action="/optimize" method="post">

        <table class="table table-striped mt-4">
            <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>Name</th>
                <th>Path</th>
                <th>Size</th>
                <th>Last Modified</th>
            </tr>
            </thead>

            <tbody>
            {% for file in files %}
            <tr>
                <td><input type="checkbox" name="selected_files" value="{{ file.path }}"></td>
                <td>{{ file.name }}</td>
                <td>{{ file.path }}</td>
                <td>{{ file.size }}</td>
                <td>{{ file.last_modified }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        <select name="optimization_type" class="form-select mb-3">
            <option value="compress">Compress to ZIP</option>
            <option value="convert_images">Convert Images to WebP</option>
        </select>

        <button class="btn btn-primary">Optimize Selected</button>

    </form>

    <!-- Pagination -->
    <nav class="mt-4">
        <ul class="pagination justify-content-center">

            <li class="page-item {% if page<=1 %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('dashboard', page=page-1, sort_by=sort_by, sort_order=sort_order, filter_text=filter_text) }}">
                    Previous
                </a>
            </li>

            {% for p in range(1, total_pages+1) %}
            <li class="page-item {% if p==page %}active{% endif %}">
                <a class="page-link"
                   href="{{ url_for('dashboard', page=p, sort_by=sort_by, sort_order=sort_order, filter_text=filter_text) }}">
                    {{ p }}
                </a>
            </li>
            {% endfor %}

            <li class="page-item {% if page>=total_pages %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('dashboard', page=page+1, sort_by=sort_by, sort_order=sort_order, filter_text=filter_text) }}">
                    Next
                </a>
            </li>

        </ul>
    </nav>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>

// dark mode
const toggleSwitch = document.getElementById('checkbox');
const currentTheme = localStorage.getItem('theme');
if (currentTheme === 'dark-mode') {
    document.body.classList.add('dark-mode');
    toggleSwitch.checked = true;
}
toggleSwitch.addEventListener('change', e => {
    if (e.target.checked) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light-mode');
    }
});

// select all
document.getElementById('select-all')?.addEventListener('click', e => {
    document.querySelectorAll('input[name="selected_files"]').forEach(cb => cb.checked = e.target.checked);
});

const bindSelectAll = (id, cls) => {
    const el = document.getElementById(id);
    if (el) {
        el.onclick = () => document.querySelectorAll("." + cls).forEach(cb => cb.checked = el.checked);
    }
};

bindSelectAll("select-all-junk-files", "junk-file-checkbox");
bindSelectAll("select-all-empty-folders", "empty-folder-checkbox");
bindSelectAll("select-all-dormant-files", "dormant-file-checkbox");

// charts
new Chart(document.getElementById('fileTypeChart'), {
    type: 'pie',
    data: {
        labels: {{ file_types|tojson }},
        datasets: [{
            data: {{ file_type_counts|tojson }},
            backgroundColor: [
                'rgba(255,99,132,0.2)',
                'rgba(54,162,235,0.2)',
                'rgba(255,206,86,0.2)',
                'rgba(75,192,192,0.2)',
                'rgba(153,102,255,0.2)',
                'rgba(255,159,64,0.2)'
            ]
        }]
    }
});

new Chart(document.getElementById('folderSizeChart'), {
    type: 'bar',
    data: {
        labels: {{ folder_names|tojson }},
        datasets: [{
            label: 'Folder Sizes',
            data: {{ folder_sizes|tojson }},
            backgroundColor: 'rgba(54,162,235,0.2)',
            borderColor: 'rgba(54,162,235,1)',
            borderWidth: 1
        }]
    },
    options: { scales: { y: { beginAtZero: true } } }
});

</script>

</body>
</html>
